"""
Airline Customer Service Synthetic Dataset Generator
Generates 1060 Russian-language customer service messages with ground truth labels
for testing ML analytics pipeline (sentiment, emotion, topic classification)
"""

import json
import csv
import random
from pathlib import Path
from typing import List, Dict
import pandas as pd
from datetime import datetime, timezone

# Dataset Configuration
TOTAL_MESSAGES = 1060
SENTIMENT_DIST = {
    'negative': 424,
    'neutral': 318,
    'positive': 318
}

TOPICS = [
    'багаж', 'бронирование', 'отмена_рейса', 'задержка', 'возврат',
    'обслуживание_на_борту', 'регистрация', 'цены', 'программа_лояльности', 'жалоба'
]

EMOTIONS = {
    'negative': ['злость', 'разочарование', 'беспокойство', 'недовольство'],
    'neutral': ['нейтральность', 'любопытство', 'ожидание'],
    'positive': ['удовлетворение', 'благодарность', 'радость']
}

# Message Templates by Topic and Sentiment
TEMPLATES = {
    'багаж': {
        'negative': [
            'Мой багаж потерян после рейса {flight}! Номер багажной бирки {tag}. Это недопустимо!',
            'Уже {days} дня жду свой чемодан с рейса {flight}. Где мои вещи?!',
            'Багаж поврежден после перелета {flight}. Чемодан разбит, вещи испорчены!',
            'Потеряли мой багаж на рейсе {flight}. Никто не может сказать, где он находится!',
            'Мой чемодан не прилетел вместе со мной рейсом {flight}. Это катастрофа!',
            'Багаж задержали на {days} дней! Рейс {flight}. Где компенсация?!',
            'Чемодан вскрыли и украли вещи на рейсе {flight}! Возмутительно!',
            'Багажная служба работает отвратительно! Потеряли чемодан с рейса {flight}!',
        ],
        'neutral': [
            'Здравствуйте, как я могу отследить свой багаж с рейса {flight}?',
            'Подскажите, каковы правила провоза багажа на рейсе {flight}?',
            'Какой максимальный вес багажа разрешен на международных рейсах?',
            'Можно ли добавить дополнительное место багажа к билету на рейс {flight}?',
            'Какова процедура получения багажа в аэропорту назначения?',
            'Как оформить декларацию на поврежденный багаж?',
            'Какие предметы запрещены в ручной клади?',
        ],
        'positive': [
            'Спасибо большое за помощь с поиском моего багажа! Всё нашли быстро.',
            'Отличная работа службы багажа! Доставили чемодан в отель в течение {hours} часов.',
            'Благодарю за оперативное решение вопроса с поврежденным багажом.',
            'Очень довольна сервисом доставки багажа. Всё пришло вовремя.',
            'Спасибо за профессиональную помощь с багажом на рейсе {flight}!',
            'Багажная служба работает отлично! Нашли мой чемодан за {hours} часа.',
        ]
    },
    'бронирование': {
        'negative': [
            'Не могу забронировать билет на сайте! Система постоянно выдает ошибку!',
            'Оплата прошла, но билет не забронирован! Что происходит?!',
            'Пытаюсь забронировать рейс {flight} уже час, сайт не работает!',
            'Бронирование сорвалось на последнем этапе. Деньги списаны, билета нет!',
            'Ваш сайт бронирования ужасен! Невозможно купить билет!',
            'Система выдает ошибку при выборе мест на рейс {flight}!',
            'Двойное списание при бронировании! Верните деньги!',
        ],
        'neutral': [
            'Как я могу забронировать билет на рейс {flight} через ваш сайт?',
            'Подскажите, можно ли забронировать места для группы из {count} человек?',
            'Какие документы нужны для бронирования международного рейса?',
            'Можно ли изменить дату бронирования после покупки билета?',
            'Как работает система выбора мест при бронировании?',
            'Какие способы оплаты доступны при бронировании?',
        ],
        'positive': [
            'Забронировала билеты очень легко! Интуитивно понятный интерфейс.',
            'Спасибо за удобную систему бронирования. Всё прошло быстро.',
            'Отличный сервис бронирования! Купила билеты за {minutes} минут.',
            'Очень довольна процессом бронирования. Всё понятно и просто.',
            'Благодарю за помощь с бронированием билетов на рейс {flight}!',
        ]
    },
    'отмена_рейса': {
        'negative': [
            'Рейс {flight} отменен без предупреждения! Я застряла в аэропорту!',
            'Отменили мой рейс за час до вылета! Это безобразие!',
            'Рейс {flight} отменен, компенсацию не предлагают! Как так?!',
            'Третий раз за месяц отменяют рейс! Это неуважение к пассажирам!',
            'Отмена рейса {flight} сорвала все мои планы! Требую компенсацию!',
            'Узнал об отмене рейса {flight} только в аэропорту! Кошмар!',
            'Отменили рейс и не предложили альтернативы! Что делать?!',
        ],
        'neutral': [
            'Добрый день, мой рейс {flight} был отменен. Какие у меня варианты?',
            'Подскажите процедуру возврата средств при отмене рейса авиакомпанией.',
            'Какая компенсация полагается при отмене рейса {flight}?',
            'Можно ли пересадить меня на другой рейс вместо отмененного {flight}?',
            'Что делать, если рейс отменен за {hours} часов до вылета?',
        ],
        'positive': [
            'Спасибо за оперативную помощь при отмене рейса {flight}. Пересадили на следующий.',
            'Благодарю за компенсацию и быструю пересадку на другой рейс.',
            'Несмотря на отмену рейса, персонал помог решить все вопросы.',
            'Спасибо за профессионализм при отмене рейса {flight}!',
            'Оценила вашу заботу о пассажирах при отмене рейса.',
        ]
    },
    'задержка': {
        'negative': [
            'Рейс {flight} задерживается уже {hours} часа! Никакой информации!',
            'Опаздываю на важную встречу из-за задержки вашего рейса!',
            'Рейс {flight} снова задерживают! Это уже постоянная практика!',
            'Задержка {hours} часов без объяснений и компенсации! Безобразие!',
            'Сидим в самолете уже час, вылет откладывают! Что происходит?!',
            'Постоянные задержки рейса {flight}! Это норма для вас?!',
            'Задержка на {hours} часа испортила все планы!',
        ],
        'neutral': [
            'Здравствуйте, когда ожидается вылет рейса {flight}? Есть задержка.',
            'Какова причина задержки рейса {flight} и когда планируется вылет?',
            'Подскажите, положена ли компенсация при задержке рейса на {hours} часов?',
            'Можно ли узнать актуальную информацию по задержке рейса {flight}?',
            'Какие права у пассажиров при задержке рейса более {hours} часов?',
        ],
        'positive': [
            'Спасибо за информирование о задержке рейса {flight} и организацию питания.',
            'Благодарю персонал за заботу во время задержки. Предложили напитки.',
            'Несмотря на задержку, экипаж делал всё возможное для комфорта.',
            'Спасибо за компенсацию и понимание неудобств из-за задержки.',
            'Оцениваю профессионализм команды во время задержки рейса {flight}.']
    },
    'возврат': {
        'negative': [
            'Жду возврат денег за билет уже {days} дней! Где мои деньги?!',
            'Отменила рейс {flight}, а возврат не приходит! Это мошенничество!',
            'Возврат обещали за {days} дней, прошел месяц - денег нет!',
            'Невозможно вернуть деньги за билет! Ваша служба поддержки не отвечает!',
            'Требую немедленного возврата средств за отмененный рейс {flight}!',
            'Возврат оформили частично! Где остальные деньги?!',
            'Жду возврат уже {days} дней! Когда вернете деньги?!',
        ],
        'neutral': [
            'Здравствуйте, как оформить возврат билета на рейс {flight}?',
            'Какие условия возврата средств при отмене билета заранее?',
            'Подскажите сроки возврата денег после отмены бронирования.',
            'Можно ли вернуть часть стоимости билета на рейс {flight}?',
            'Какие документы нужны для оформления возврата билета?',
        ],
        'positive': ['Спасибо за быстрый возврат средств! Деньги вернулись за {days} дней.',
            'Благодарю за понимание и оперативный возврат стоимости билета.',
            'Отличная работа отдела возвратов! Всё прошло без проблем.',
            'Спасибо за помощь с оформлением возврата за рейс {flight}.',
            'Очень довольна процессом возврата. Всё быстро и профессионально.',
        ]
    },
    'обслуживание_на_борту': {
        'negative': [
            'Обслуживание на рейсе {flight} отвратительное! Грубый персонал!',
            'Не было еды на рейсе длительностью {hours} часов! Это безобразие!',
            'Стюардессы хамили пассажирам на рейсе {flight}. Неприемлемо!',
            'Кондиционер не работал весь полет! Температура была невыносимой!',
            'Ужасное питание на борту рейса {flight}. Несвежие продукты!',
            'Грубое обслуживание на борту! Стюардессы игнорировали пассажиров!',
            'Холодная еда на рейсе {flight}! Отвратительно!',
        ],
        'neutral': [
            'Какое питание предусмотрено на рейсе {flight} продолжительностью {hours} часов?',
            'Можно ли заказать специальное меню на борту?',
            'Подскажите, есть ли Wi-Fi на рейсе {flight}?',
            'Какие развлекательные программы доступны на борту?',
            'Можно ли получить дополнительное одеяло во время полета?',
        ],
        'positive': [
            'Прекрасное обслуживание на рейсе {flight}! Экипаж очень внимательный.',
            'Спасибо стюардессам за заботу и улыбки во время полета!',
            'Отличное питание на борту! Всё свежее и вкусное.',
            'Благодарю экипаж рейса {flight} за профессионализм и доброжелательность.',
            'Очень комфортный полет благодаря заботливому персоналу!',
        ]
    },
    'регистрация': {
        'negative': [
            'Очередь на регистрацию на рейс {flight} - {hours} часа! Ужас!',
            'Онлайн-регистрация не работает! Застрял в аэропорту!',
            'Не могу зарегистрироваться на рейс {flight}! Сайт выдает ошибку!',
            'Регистрация закрылась за {minutes} минут до рейса! Не пустили!',
            'Кошмарная организация регистрации! Пропустил рейс из-за очереди!',
            'Стойки регистрации на рейс {flight} работают медленно!',
            'Онлайн-регистрация недоступна для рейса {flight}! Почему?!',
        ],
        'neutral': [
            'Здравствуйте, как пройти онлайн-регистрацию на рейс {flight}?',
            'За сколько времени до вылета открывается регистрация на рейс?',
            'Можно ли зарегистрироваться на рейс {flight} в мобильном приложении?',
            'Какие документы нужны для регистрации на международный рейс?',
            'Подскажите, где находится стойка регистрации на рейс {flight}?',
        ],
        'positive': [
            'Онлайн-регистрация на рейс {flight} прошла отлично! Очень удобно.',
            'Спасибо за быструю регистрацию! Очереди не было.',
            'Отличная организация процесса регистрации. Всё заняло {minutes} минут.',
            'Благодарю за помощь при регистрации с детьми на рейс {flight}.',
            'Очень удобная система онлайн-регистрации! Рекомендую!',
        ]
    },
    'цены': {
        'negative': [
            'Цены на рейс {flight} взлетели в {times} раза за неделю! Это грабеж!',
            'Почему билеты такие дорогие?! Раньше было в {times} раза дешевле!',
            'Неоправданно высокие цены на багаж! {price} рублей за чемодан!',
            'Скрытые платежи при бронировании! Итоговая цена на {percent}% выше!',
            'Ваши тарифы самые дорогие на рынке! У конкурентов в {times} раза дешевле!',
            'Цены растут каждый день! Билет на {flight} стоит {price} рублей!',
            'Дополнительные сборы не указаны при бронировании! Обман!',
        ],
        'neutral': [
            'Подскажите, какие тарифы доступны на рейс {flight}?',
            'Когда обычно бывают скидки на билеты?',
            'Как формируется цена билета на рейс {flight}?',
            'Можно ли узнать о специальных предложениях на ближайшие даты?',
            'Какая разница между тарифами "эконом" и "гибкий"?',
        ],
        'positive': [
            'Спасибо за отличные цены на рейс {flight}! Очень выгодно.',
            'Поймала акцию со скидкой {percent}%! Супер!',
            'Благодарю за программу лояльности. Накопила мили и купила билет дешевле.',
            'Отличное соотношение цены и качества на рейсе {flight}.',
            'Спасибо за прозрачное ценообразование без скрытых платежей!',
        ]
    },
    'программа_лояльности': {
        'negative': [
            'Мили не начислились за рейс {flight}! Уже {days} день жду!',
            'Программа лояльности не работает! Потерял все накопленные мили!',
            'Не могу использовать мили для оплаты билета! Система не принимает!',
            'Правила программы постоянно меняются не в пользу клиентов!',
            'Потратил {miles} миль на билет, а получил ужасное место!',
            'Мили сгорели без предупреждения! Это несправедливо!',
            'Программа лояльности - обман! Мили не начисляются!',
        ],
        'neutral': [
            'Здравствуйте, как вступить в программу лояльности?',
            'Какие преимущества дает статус {level} в программе лояльности?',
            'Подскажите, как начисляются мили за рейс {flight}?',
            'Можно ли использовать мили для оплаты дополнительного багажа?',
            'Какой срок действия накопленных миль?',
        ],
        'positive': [
            'Отличная программа лояльности! Накопил мили и улетел бесплатно!',
            'Спасибо за повышение статуса! Привилегии действительно стоящие.',
            'Благодарю за бонусные мили к рейсу {flight}!',
            'Очень довольна программой. Использую мили для апгрейдов.',
            'Программа лояльности - лучшая среди авиакомпаний! Спасибо!',
        ]
    },
    'жалоба': {
        'negative': [
            'Подаю официальную жалобу на действия экипажа рейса {flight}!',
            'Хочу пожаловаться на хамское поведение сотрудника на регистрации!',
            'Это не первая проблема с вашей авиакомпанией! Буду писать везде!',
            'Требую разбирательства и компенсации за испорченный отпуск!',
            'Направлю жалобу в надзорные органы! Ваш сервис недопустим!',
            'Жалоба на рейс {flight}! Неприемлемое обращение с пассажирами!',
            'Оставляю официальную жалобу на работу персонала!',
        ],
        'neutral': [
            'Здравствуйте, как я могу оставить официальную жалобу?',
            'Подскажите процедуру рассмотрения жалоб пассажиров.',
            'Куда отправить письменную жалобу по поводу рейса {flight}?',
            'Какие сроки рассмотрения жалоб в вашей компании?',
            'Можно ли подать жалобу через мобильное приложение?',
        ],
        'positive': [
            'Спасибо за оперативное рассмотрение моей жалобы!',
            'Благодарю за внимание к проблеме и решение вопроса.',
            'Оцениваю профессиональную работу отдела по работе с жалобами.',
            'Спасибо за компенсацию и извинения. Вопрос решен.',
            'Приятно удивлена качеством обработки обратной связи!',
        ]
    }
}


def fill_template(template: str) -> str:
    """Fill template placeholders with random values"""
    return (template
            .replace('{flight}', f'SU{random.randint(100, 999)}')
            .replace('{tag}', f'{random.randint(10000, 99999)}')
            .replace('{days}', str(random.randint(1, 14)))
            .replace('{hours}', str(random.randint(1, 10)))
            .replace('{count}', str(random.randint(5, 14)))
            .replace('{minutes}', str(random.randint(10, 59)))
            .replace('{times}', str(random.randint(2, 4)))
            .replace('{price}', str(random.randint(10, 40) * 100))
            .replace('{percent}', str(random.randint(20, 50)))
            .replace('{miles}', str(random.randint(10, 60) * 1000))
            .replace('{level}', random.choice(['Серебряный', 'Золотой', 'Платиновый'])))


def generate_dataset() -> List[Dict]:
    """Generate the complete dataset with only 4 required fields"""
    dataset = []
    message_id = 1

    print("Generating synthetic dataset...")
    print(f"Target: {TOTAL_MESSAGES} messages")
    print(f"Distribution: {SENTIMENT_DIST}")
    print("-" * 60)

    for sentiment, count in SENTIMENT_DIST.items():
        messages_per_topic = count // len(TOPICS)
        remainder = count % len(TOPICS)

        print(f"\nGenerating {sentiment} messages ({count} total)...")

        for topic_idx, topic in enumerate(TOPICS):
            topic_count = messages_per_topic + (1 if topic_idx < remainder else 0)
            topic_templates = TEMPLATES.get(topic, {}).get(sentiment, [])

            if not topic_templates:
                print(f"  Warning: No templates for {topic}/{sentiment}")
                continue

            for _ in range(topic_count):
                template = random.choice(topic_templates)
                message_text = fill_template(template)

                # Generate user_id (anonymized)
                user_id = f"user_{random.randint(1000, 9999)}"
                # Generate external_id (for deduplication)
                external_id = f"ext_{message_id}"
                # Generate timestamp in ISO 8601 format (UTC)
                timestamp = datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%SZ")

                dataset.append({
                    'text': message_text,
                    'user_id': user_id,
                    'external_id': external_id,
                    'timestamp': timestamp
                })

                message_id += 1

            print(f"  ✓ {topic}: {topic_count} messages")

    print(f"\n{'=' * 60}")
    print(f"Total messages generated: {len(dataset)}")
    return dataset


def save_as_csv(dataset: List[Dict], filename: str = 'dataset.csv'):
    """Save dataset as CSV with only 4 columns"""
    with open(filename, 'w', encoding='utf-8', newline='') as f:
        writer = csv.DictWriter(f, fieldnames=['text', 'user_id', 'external_id', 'timestamp'])
        writer.writeheader()
        for row in dataset:
            writer.writerow(row)
    print(f"✓ Saved: {filename}")


def save_as_json(dataset: List[Dict], filename: str = 'dataset.json'):
    """Save dataset as JSON with only 4 columns"""
    with open(filename, 'w', encoding='utf-8') as f:
        json.dump(dataset, f, ensure_ascii=False, indent=2)
    print(f"✓ Saved: {filename}")


def save_as_jsonl(dataset: List[Dict], filename: str = 'dataset.jsonl'):
    """Save dataset as JSONL (one JSON object per line)"""
    with open(filename, 'w', encoding='utf-8') as f:
        for row in dataset:
            json.dump(row, f, ensure_ascii=False)
            f.write('\n')
    print(f"✓ Saved: {filename}")


def save_as_parquet(dataset: List[Dict], filename: str = 'dataset.parquet'):
    """Save dataset as Parquet using pandas"""
    df = pd.DataFrame(dataset)
    df.to_parquet(filename, index=False, engine='pyarrow')
    print(f"✓ Saved: {filename}")


def save_as_xlsx(dataset: List[Dict], filename: str = 'dataset.xlsx'):
    """Save dataset as XLSX using pandas"""
    df = pd.DataFrame(dataset)
    df.to_excel(filename, index=False, engine='openpyxl')
    print(f"✓ Saved: {filename}")


if __name__ == "__main__":
    dataset = generate_dataset()
    save_as_csv(dataset)
    save_as_json(dataset)
    save_as_jsonl(dataset)
    save_as_parquet(dataset)
    save_as_xlsx(dataset)